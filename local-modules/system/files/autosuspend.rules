# Managed by puppet

# To get attributes, use:
#   udevadm info --attribute-walk --path=/sys/bus/usb/devices/usb3/...
# Note this may conflict with TLP (check USB_AUTOSUSPEND in /etc/default/tlp)

# Blacklist:
## OneLink Pro Dock ethernet device (otherwise, link won't come up)
ACTION=="add|change", SUBSYSTEM=="usb", ATTR{product}=="ThinkPad Dock Giga", \
                      GOTO="power_autosuspend_disable"
## OneLink Pro Dock USB stuff (otherwise, they pause all the time and keyboard doesn't work)
ACTION=="add|change", SUBSYSTEM=="usb", ATTR{product}=="OneLink Pro Dock", \
                      GOTO="power_autosuspend_disable"
## MST screens
ACTION=="add|change", SUBSYSTEM=="drm", KERNEL=="card0-DP-3", ATTR{status}=="connected", \
                      GOTO="power_autosuspend_disable"
ACTION=="add|change", SUBSYSTEM=="drm", KERNEL=="card0-DP-4", ATTR{status}=="connected", \
                      GOTO="power_autosuspend_disable"
ACTION=="add|change", SUBSYSTEM=="drm", KERNEL=="card0-DP-5", ATTR{status}=="connected", \
                      GOTO="power_autosuspend_disable"

## Generic HID stuff
ACTION=="add|change", SUBSYSTEM=="usb", DRIVER=="usbhid", \
                      ATTR{../manufacturer}!="ELAN", \
                      TEST=="../power/control", ATTR{../power/control}="on", \
                      GOTO="power_autosuspend_end"

# Enable autosuspend for the remaining
ACTION=="add|change", SUBSYSTEM=="usb", TEST=="power/control", ATTR{power/control}="auto"
ACTION=="add|change", SUBSYSTEM=="pci", TEST=="power/control", ATTR{power/control}="auto"
ACTION=="add|change", SUBSYSTEM=="drm", TEST=="power/control", ATTR{power/control}="auto"
GOTO="power_autosuspend_end"

# Disable blacklisted
LABEL="power_autosuspend_disable"
ACTION=="add|change", TEST=="power/control", ATTR{power/control}="on"

LABEL="power_autosuspend_end"
